# 对话配置

<cite>
**本文档引用的文件**   
- [config.yaml](file://config/config.yaml)
- [tenant.go](file://internal/types/tenant.go)
- [rewrite.go](file://internal/application/service/chat_pipline/rewrite.go)
- [search.go](file://internal/application/service/chat_pipline/search.go)
- [rerank.go](file://internal/application/service/chat_pipline/rerank.go)
- [filter_top_k.go](file://internal/application/service/chat_pipline/filter_top_k.go)
- [chat_pipline.go](file://internal/application/service/chat_pipline/chat_pipline.go)
</cite>

## 目录
1. [引言](#引言)
2. [核心参数详解](#核心参数详解)
3. [检索流程控制开关](#检索流程控制开关)
4. [查询重写机制](#查询重写机制)
5. [实际场景配置示例](#实际场景配置示例)
6. [总结](#总结)

## 引言
本文档详细解析了对话系统中`conversation`配置块的各项参数。该配置块定义了对话的核心行为，包括检索策略、查询处理、结果重排和回退机制。通过深入分析`config.yaml`文件中的配置项及其在代码中的实现，本文旨在为开发者和系统管理员提供一份全面的配置指南，帮助他们根据具体应用场景优化对话系统的性能和用户体验。

## 核心参数详解

`conversation`配置块中的数值型参数是控制检索质量和效率的关键。这些参数共同决定了系统如何从知识库中查找、筛选和排序相关信息。

### 检索轮次与召回数量控制

`max_rounds` 和 `embedding_top_k` 是控制检索范围的两个基础参数。

`max_rounds` 参数定义了在进行查询重写时，系统可以参考的最近对话轮次数量。在代码实现中（`rewrite.go`），该参数用于限制从数据库中获取的历史消息数量。一个较高的值（如10）可以让系统更好地理解长期对话上下文，但会增加处理延迟和计算成本。对于大多数问答场景，5-6轮的上下文通常已足够。

`embedding_top_k` 参数则直接控制了向量检索的召回数量。在`search.go`文件中，此参数被用作`SearchParams.MatchCount`，决定了从向量数据库中返回的最相似的文本片段（chunks）的数量。这是一个典型的召回率（Recall）与精确率（Precision）的权衡点。设置过低（如3）可能导致遗漏关键信息，而设置过高（如20）则会引入大量不相关的结果，增加后续处理的负担。建议从10开始，根据知识库的密度和查询的复杂性进行调整。

**Section sources**
- [config.yaml](file://config/config.yaml#L8)
- [rewrite.go](file://internal/application/service/chat_pipline/rewrite.go#L119-L125)
- [search.go](file://internal/application/service/chat_pipline/search.go#L322)

### 相似度阈值与重排机制

`keyword_threshold`、`vector_threshold` 和 `rerank_threshold` 是三个核心的相似度过滤阈值，它们分别作用于检索流程的不同阶段。

`keyword_threshold` 用于关键词匹配的过滤。在`search.go`中，该阈值被传递给`HybridSearch`方法，用于过滤基于关键词（如TF-IDF）匹配的结果。一个较低的阈值（如0.3）会放宽匹配条件，提高召回率，但可能引入噪声。一个较高的阈值（如0.7）则会严格匹配，提高精确率，但可能导致漏检。

`vector_threshold` 用于向量相似度的过滤。同样在`search.go`中，该阈值用于过滤基于向量嵌入（Embedding）计算出的相似度得分。由于向量搜索是主要的召回手段，此阈值对整体性能影响巨大。通常，向量相似度得分在0.5以上被认为是较为相关的。建议将此阈值设置得比`keyword_threshold`稍高，以确保向量召回的质量。

`rerank_threshold` 是重排阶段的最终过滤器。在`rerank.go`中，重排模型（Reranker）会为每个候选结果生成一个相关性分数，只有分数高于此阈值的结果才会被保留。这是保证最终结果质量的最后一道防线。一个较高的`rerank_threshold`（如0.7）能确保返回的结果高度相关，但可能导致结果过少。系统还实现了智能降级机制：当重排后无结果时，会自动降低阈值（降至原值的70%或0.3）并重试，以平衡鲁棒性和精确率。

`rerank_top_k` 参数定义了在重排和过滤后，最终返回给大模型进行回答的上下文片段数量。在`filter_top_k.go`中，此参数用于截断`RerankResult`列表。这个值直接决定了大模型的输入长度，对生成答案的质量和响应时间有直接影响。通常，5-8个高质量的上下文片段足以支撑一个详尽的回答。

**Section sources**
- [config.yaml](file://config/config.yaml#L9-L13)
- [search.go](file://internal/application/service/chat_pipline/search.go#L321-L322)
- [rerank.go](file://internal/application/service/chat_pipline/rerank.go#L80-L98)

## 检索流程控制开关

`enable_rewrite`、`enable_query_expansion` 和 `enable_rerank` 是三个关键的布尔开关，它们决定了对话系统检索流程的复杂度和智能程度。

### 查询重写 (enable_rewrite)

`enable_rewrite` 开关控制着查询重写功能的启用。当此开关为`true`时，系统会启动一个复杂的重写流程。如`rewrite.go`文件所示，该流程首先获取最近的对话历史，然后利用`rewrite_prompt_system`和`rewrite_prompt_user`这两个模板，通过大模型对用户的原始查询进行改写。改写的主要目的是进行指代消解（例如，将“它”替换为“微信支付”）和补全省略信息，从而生成一个语义完整、独立的查询。这对于多轮对话至关重要，能显著提升后续检索的准确性。关闭此功能会直接使用用户的原始查询，可能导致在上下文缺失时检索失败。

### 查询扩展 (enable_query_expansion)

`enable_query_expansion` 开关控制着查询扩展功能。此功能在`search.go`的`expandQueries`方法中实现。当系统检测到初始检索结果数量过少（少于`embedding_top_k`的一半）时，会自动触发查询扩展。它通过移除停用词、提取关键词、分割长句等简单但高效的方法，生成原始查询的多个变体（如“如何提高英语口语” -> “提高英语口语”）。然后，系统会使用这些变体并以更低的`keyword_threshold`进行二次检索，以提高关键词匹配的召回率。这是一个非常实用的“兜底”策略，能有效应对向量检索失效的场景。

### 结果重排 (enable_rerank)

`enable_rerank` 开关控制着结果重排功能。当此开关为`true`时，系统会在向量和关键词检索之后，调用一个专门的重排模型（由`rerank_model_id`指定）对候选结果进行精细化排序。如`rerank.go`文件所示，重排模型会综合考虑查询与文本片段的语义相关性，并计算一个更精确的相关性分数。随后，系统会应用`rerank_threshold`进行过滤，并使用MMR（Maximal Marginal Relevance）算法对结果进行去重和多样性控制，确保最终返回的上下文既相关又不冗余。启用重排是提升回答质量的关键步骤，尤其是在知识库内容复杂或查询模糊的情况下。

**Section sources**
- [config.yaml](file://config/config.yaml#L39-L41)
- [rewrite.go](file://internal/application/service/chat_pipline/rewrite.go#L60-L65)
- [search.go](file://internal/application/service/chat_pipline/search.go#L132-L142)
- [rerank.go](file://internal/application/service/chat_pipline/rerank.go#L52-L57)

## 查询重写机制

查询重写功能是提升多轮对话体验的核心。其工作原理依赖于两个精心设计的提示词模板：`rewrite_prompt_system` 和 `rewrite_prompt_user`。

### 实现原理

如`rewrite.go`文件中的代码逻辑所示，查询重写是一个典型的“模板+大模型”调用过程。系统首先将对话历史和用户当前的查询，按照`rewrite_prompt_user`模板的格式填充，生成用户消息。同时，将`rewrite_prompt_system`模板作为系统消息。然后，将这两条消息发送给由`chat_model_id`指定的大模型进行处理。大模型的任务是根据系统消息中的指令，对用户消息中的查询进行改写，并仅输出改写后的结果。改写后的查询（`chatManage.RewriteQuery`）将被用于后续的检索流程，而原始查询（`chatManage.Query`）则被保留用于记录和分析。

### 自定义方法

要自定义查询重写行为，用户可以直接修改`config.yaml`中的`rewrite_prompt_system`和`rewrite_prompt_user`字段。`rewrite_prompt_system`定义了重写任务的规则和目标，例如要求进行指代消解、保持问题形式、控制输出长度等。`rewrite_prompt_user`则定义了输入数据的结构，它使用Go模板语法（如`{{.Query}}`和`{{range .Conversation}}`）来动态插入实际的查询和对话历史。通过调整这些模板，可以改变重写模型的行为，例如增加对时间信息的处理，或要求模型在无法确定指代时进行澄清。

**Section sources**
- [config.yaml](file://config/config.yaml#L42-L108)
- [rewrite.go](file://internal/application/service/chat_pipline/rewrite.go#L143-L189)

## 实际场景配置示例

### 平衡召回率与精确率

在知识库内容丰富但查询多样的场景下，需要精细调整阈值以平衡召回率和精确率。

```yaml
conversation:
  # 为了提高召回率，放宽关键词和向量匹配的阈值
  keyword_threshold: 0.2
  vector_threshold: 0.4
  # 同时，提高重排阈值，确保最终结果的精确率
  rerank_threshold: 0.6
  # 增加重排后的Top-K数量，为大模型提供更多上下文
  rerank_top_k: 8
  enable_rerank: true
```

此配置通过在早期阶段（关键词和向量搜索）使用较低的阈值来“宁可错杀，不可放过”，尽可能多地召回潜在相关的结果。然后，依赖强大的重排模型和较高的`rerank_threshold`来精确筛选，确保最终传递给大模型的上下文是高质量的。

### 优化用户体验的回退策略

当检索无结果时，`fallback_strategy`配置决定了系统的应对方式。

```yaml
conversation:
  # 使用'model'策略，让大模型基于提示词生成更智能的回复
  fallback_strategy: "model"
  fallback_prompt: |
    你是一个专业、友好的AI助手。现在用户提出的问题超出了你的知识库范围，你需要生成一个礼貌且有帮助的回复。
    
    ## 回复要求
    - 诚实承认你无法提供准确答案
    - 简洁友好，不要过度道歉
    - 可以提供相关的建议或替代方案
    - 回复控制在50字以内
    - 使用礼貌、专业的语气
    
    ## 用户当前的问题是:
    {{.Query}}
```

与简单的`fixed`策略（返回固定的字符串）相比，`model`策略更具灵活性。系统会将`fallback_prompt`与用户的问题结合，再次调用大模型来生成一个上下文相关的、有帮助的回复。如配置所示，通过提供清晰的指令和示例，可以引导模型生成符合预期的、专业的回退回复，从而显著提升用户体验。

**Section sources**
- [config.yaml](file://config/config.yaml#L14-L38)

## 总结
对话配置是整个问答系统的核心。通过对`max_rounds`、`embedding_top_k`等参数的合理设置，可以控制检索的广度和深度。`keyword_threshold`、`vector_threshold`和`rerank_threshold`这三个阈值构成了一个从粗到细的过滤漏斗，是平衡召回率与精确率的关键。`enable_rewrite`、`enable_query_expansion`和`enable_rerank`等开关则赋予了系统不同层次的智能。最后，通过精心设计`rewrite_prompt`和`fallback_prompt`模板，可以极大地提升系统的交互能力和用户体验。建议在实际部署中，根据知识库的特点和用户需求，通过A/B测试逐步调优这些参数。